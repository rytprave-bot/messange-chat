<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Приватный Чат с Таймером</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; padding: 20px; margin: 0; }
        .container { max-width: 600px; margin: auto; display: flex; flex-direction: column; height: 90vh; }
        #chat { flex-grow: 1; border: 1px solid #444; overflow-y: auto; margin: 10px 0; padding: 15px; background: #1e1e1e; border-radius: 8px; }
        .id-box { background: #222; padding: 15px; border-radius: 8px; border-left: 5px solid #00ffcc; margin-bottom: 10px; position: relative; }
        input { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; flex-grow: 1; }
        button { padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .timer { color: #ffca28; font-weight: bold; }
        .status { color: #aaa; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="id-box">
            <div id="loading-area">
                <strong>Ожидание ID:</strong> <span class="timer" id="countdown">15</span> сек...
            </div>
            <div id="id-ready" style="display: none;">
                <strong>Твой ID:</strong> <span id="my-id" style="color: #00ffcc; font-size: 1.2em; font-family: monospace;"></span>
            </div>
            <div id="status" class="status">Статус: Подключение к сигнальному серверу...</div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="peer-id-input" placeholder="Вставь ID друга">
            <button onclick="connectToPeer()">Соединить</button>
        </div>

        <div id="chat"></div>

        <div style="display: flex; gap: 10px;">
            <input type="text" id="message-input" placeholder="Сообщение..." onkeypress="if(event.keyCode==13) sendMessage()">
            <button onclick="sendMessage()" style="background: #007bff;">Послать</button>
        </div>
    </div>

    <script>
        let timeLeft = 15;
        const timerElement = document.getElementById('countdown');
        const loadingArea = document.getElementById('loading-area');
        const idReadyArea = document.getElementById('id-ready');
        const statusDisplay = document.getElementById('status');
        
        // Запуск отсчета
        const timerId = setInterval(() => {
            timeLeft--;
            timerElement.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timerId);
                if (document.getElementById('my-id').innerText === "") {
                    statusDisplay.innerHTML = "<b style='color:red'>Время истекло. ID не получен. Попробуй обновить страницу или зайти с телефона.</b>";
                }
            }
        }, 1000);

        // Инициализация PeerJS
        const peer = new Peer();
        let conn;

        peer.on('open', (id) => {
            clearInterval(timerId); // Останавливаем таймер
            loadingArea.style.display = 'none'; // Прячем таймер
            idReadyArea.style.display = 'block'; // Показываем ID
            document.getElementById('my-id').innerText = id;
            statusDisplay.innerText = "Статус: Онлайн. Можно общаться!";
        });

        peer.on('connection', (c) => {
            conn = c;
            setupChat();
        });

        window.connectToPeer = function() {
            const remoteId = document.getElementById('peer-id-input').value;
            conn = peer.connect(remoteId);
            setupChat();
        };

        function setupChat() {
            conn.on('open', () => {
                statusDisplay.innerText = "Статус: Друг подключился!";
                conn.on('data', (data) => addMessage("Друг", data));
            });
        }

        window.sendMessage = function() {
            const input = document.getElementById('message-input');
            if (conn && conn.open && input.value) {
                conn.send(input.value);
                addMessage("Я", input.value);
                input.value = "";
            }
        };

        function addMessage(user, text) {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div><b>${user}:</b> ${text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        }

        // Если библиотека не загрузилась вообще
        if (typeof Peer === 'undefined') {
            clearInterval(timerId);
            statusDisplay.innerHTML = "<b style='color:red'>Ошибка: Скрипт PeerJS заблокирован провайдером или браузером.</b>";
        }
    </script>
</body>
</html>
